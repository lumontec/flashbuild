# Flashbuild
Flashbuild is a simple set of scripts to help you build a fully bootable linux os image in the shortest time with a simple and intuitive process. 
Target is to cover all the cases in which you need a specialized quick and dirty linux distro for your personal hacks and projects without getting crazy with yocto and friends.
Can be used for testing an executable full stack (e.g. debugging both user and kernel interaction) in qemu as well as to create some simple bootable image for your cross platform bare metal hardware.
The project leverages the beauty and portability of latest docker technology, and takes inspiration by the excellent work of:

[https://mudongliang.github.io/2017/09/12/how-to-build-a-custom-linux-kernel-for-qemu.html](https://mudongliang.github.io/2017/09/12/how-to-build-a-custom-linux-kernel-for-qemu.html)  
[https://mgalgs.github.io/2015/05/16/how-to-build-a-custom-linux-kernel-for-qemu-2015-edition.html](https://mgalgs.github.io/2015/05/16/how-to-build-a-custom-linux-kernel-for-qemu-2015-edition.html)  

### Let`s roll ...
In this example we roll an extremely minimal image with no rootfs, everything gets loaded in ram by making use of initramfs:
##### 1 Build your minimal kernel
We clone the official kernel repo and build the smallest kernel core with default configuration for our arch
```bash
cd ./2_kernel/build
git clone https://github.com/torvalds/linux.git .
git checkout v5.9
make defconfig
make -j8 bzImage
```
Flashbuild will need the **bzImage** compressed binary generated by kernel compilation, for 64bit arch you will find it under ./2_kernel/src/arch/x86_64/boot/bzImage.
##### 2 Generate your initramfs
We use a simple Dockerfile and an init script to mount an initramfs after the kernel is loaded. These are the steps in a nutshell:
- pull base image
- install the packages that we want
- create some user
- cleanup filesystem
- add an init script to be called by the kernel
- that`s it !

Dockerfile:
```Dockerfile

# Base image ---------------------------
# 
# We download a basic ubuntu image to copy
# our fs tree 

FROM ubuntu:20.04 AS base
RUN  apt update 
RUN  apt -y upgrade 

# Install systemd init system
RUN  apt install -y systemd udev

# Change password for root
RUN echo "root:root" | chpasswd


# Patch fs ----------------------------
# 
# We install a basic /init script that launches
# systemd after being invoked by the kernel

# Copy all fs workdir where we patch our fs 
FROM alpine:latest
WORKDIR /fs
COPY --from=base / .

# Add init script
ADD ./src/init init
```

Init file:

```bash
#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
echo -e "\nBoot took $(cut -d' ' -f1 /proc/uptime) seconds\n"
exec /bin/sh
```
Generate initramfs compressed archive:
```bash
make -C ./3_initramfs/ initramfs
```
##### 4 Emulate
```bash
./emulate.sh
```


